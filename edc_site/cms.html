<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CMS Panel</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    :root {
      --primary: #0040C5;
      /* EDC Blue */
      --danger: #b00020;
      --bg: #f0f2f5;
      --card-bg: #fff;
    }

    body {
      background: var(--bg);
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 14px;
      color: #333;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      /* Slightly larger than 60 to fit padding */
      gap: 10px;
      margin-top: 10px;
    }

    .media-item {
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      padding: 5px;
      border-radius: 4px;
      background: #fff;
      align-items: center;
      justify-content: center;
    }

    .media-item img {
      width: 60px;
      height: auto;
      max-height: 40px;
      object-fit: contain;
      cursor: pointer;
    }

    .cms-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .login-panel {
      max-width: 400px;
      margin: 10vh auto;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Layout */
    .cms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 1.5rem;
      align-items: start;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    /* Cards as Details */
    details.card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 0;
      margin-bottom: 0;
      overflow: hidden;
    }

    details.card>summary {
      padding: 1rem;
      cursor: pointer;
      font-weight: 600;
      background: #fdfdfd;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    details.card>summary::after {
      content: "▼";
      font-size: 0.8em;
    }

    details.card[open]>summary {
      border-bottom: 1px solid #eee;
    }

    details.card[open]>summary::after {
      content: "▲";
    }

    details.card>summary h2 {
      margin: 0;
      font-size: 1.1rem;
      line-height: 1.2;
    }

    .card-content {
      padding: 1.5rem;
    }

    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: #444;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      /* Fix padding issues */
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Buttons */
    button {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 4px;
      background: #e0e0e0;
      cursor: pointer;
      font-weight: 500;
    }

    button[type="submit"] {
      background: var(--primary);
      color: #fff;
    }

    button:hover {
      opacity: 0.9;
    }

    .status {
      font-weight: 600;
      margin-left: 10px;
      font-size: 0.9rem;
    }

    .status.success {
      color: green;
    }

    .status.error {
      color: red;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }
  </style>
</head>

<body>
  <div class="cms-container">
    <header>
      <div>
        <h1 id="cms-title" style="margin:0; font-size:1.5rem;">CMS Panel</h1>
        <p id="cms-intro" style="margin:0; color:#666;">Manage EDC content.</p>
      </div>
      <div>
        <a href="/" class="button"
          style="margin-left:10px; text-decoration:none; display:inline-block; font-size:0.9rem;">Back to Site</a>
      </div>
    </header>

    <!-- Login Panel -->
    <div id="login-panel" class="login-panel">
      <h2 style="margin-top:0;">Login</h2>
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" placeholder="admin">
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Password">
      </div>
      <div class="form-group">
        <button id="login-button">Log In</button>
        <span class="status" id="login-status"></span>
      </div>
      <p id="forgot-password" class="muted" style="text-align: center; margin-top: 1rem;">Forgot Password</p>
    </div>

    <!-- Main CMS Panel -->
    <div id="cms-panel" style="display: none;">
      <div class="cms-grid">
        <details class="card">
          <summary>
            <h2>Hero Content</h2>
          </summary>
          <div class="card-content">
            <form id="hero-form">
              <div class="form-group"><label for="hero-title">Title</label><input type="text" id="hero-title"
                  name="heroTitle"></div>
              <div class="form-group"><label for="hero-subtitle">Subtitle</label><input type="text" id="hero-subtitle"
                  name="heroSubtitle"></div>
              <div class="form-group">
                <label>Background Images (Slideshow)</label>
                <div id="hero-images-list" style="margin-bottom:10px;"></div>
                <button type="button" onclick="addHeroImageRow()">+ Add Image</button>
                <input type="hidden" name="heroImages" id="hero-images-json">
              </div>
              <input type="hidden" name="action" value="updateHero">
              <input type="hidden" name="password">
              <input type="hidden" name="username">
              <input type="hidden" name="lang" value="en">
              <div class="form-actions"><button type="submit">Save</button><span class="status" id="hero-status"></span>
              </div>
            </form>
          </div>
        </details>

        <details class="card">
          <summary>
            <h2>Mission</h2>
          </summary>
          <div class="card-content">
            <form id="mission-form">
              <div class="form-group"><label for="mission-title">Section Title</label><input type="text"
                  id="mission-title" name="title"></div>
              <div class="form-group"><label for="mission-lead">Intro Text</label><textarea id="mission-lead"
                  name="lead"></textarea></div>

              <h3>Mission Cards</h3>
              <div id="mission-cards-list" style="margin-bottom:10px;"></div>
              <!-- Hidden input to store JSON of cards -->
              <input type="hidden" id="mission-cards-json" name="cards">

              <input type="hidden" name="action" value="updateSection">
              <input type="hidden" name="section" value="mission">
              <input type="hidden" name="password">
              <input type="hidden" name="username">
              <input type="hidden" name="lang" value="en">
              <div class="form-actions"><button type="submit" onclick="prepareMissionData()">Save Mission</button><span
                  class="status" id="mission-status"></span></div>
            </form>
          </div>
        </details>

        <details class="card">
          <summary>
            <h2>Footer / Contact</h2>
          </summary>
          <div class="card-content">
            <form id="contact-form">
              <div class="form-group"><label>Organization Name</label><input type="text" id="contact-name"
                  name="contactName"></div>
              <div class="form-group"><label>Address</label><input type="text" id="contact-address"
                  name="contactAddress">
              </div>
              <div class="form-group"><label>Phone</label><input type="text" id="contact-phone" name="contactPhone">
              </div>
              <div class="form-group"><label>Email</label><input type="text" id="contact-email" name="contactEmail">
              </div>
              <input type="hidden" name="action" value="updateContact">
              <input type="hidden" name="password">
              <input type="hidden" name="username">
              <input type="hidden" name="lang" value="en">
              <div class="form-actions"><button type="submit">Save Contact</button><span class="status"
                  id="contact-status"></span></div>
            </form>
          </div>
        </details>

        <details class="card">
          <summary>
            <h2>Partners (Logo URL)</h2>
          </summary>
          <div class="card-content">
            <div id="partners-list" style="margin-bottom:10px;"></div>
            <button onclick="addPartnerRow()">+ Add Partner</button>
            <button onclick="savePartners()">Save Partners</button>
            <span class="status" id="partners-status"></span>
          </div>
        </details>

        <details class="card">
          <summary>
            <h2>Presidium (Board)</h2>
          </summary>
          <div class="card-content">
            <div id="presidium-list" style="margin-bottom:10px;"></div>
            <button onclick="addPresidiumRow()">+ Add Person</button>
            <button onclick="savePresidium()">Save Presidium</button>
            <span class="status" id="presidium-status"></span>
          </div>
        </details>

        <details class="card">
          <summary>
            <h2>Dealers (Map)</h2>
          </summary>
          <div class="card-content">
            <p style="font-size:0.8rem; color:#666;">Edit dealer numbers for countries (ISO code).</p>
            <div
              style="display:grid; grid-template-columns: 50px 1fr 60px 60px 60px 50px; gap:5px; font-weight:bold; font-size:0.8rem; margin-bottom:5px;">
              <span>Code</span>
              <span>Country</span>
              <span title="Audi">Audi</span>
              <span title="Volkswagen">VW</span>
              <span title="VW Samochody Użytkowe">VWC</span>
              <span>Remove</span>
            </div>
            <div id="dealers-list"
              style="margin-bottom:10px; max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:5px;"></div>
            <button onclick="addDealerRow()">+ Add Country</button>
            <button onclick="saveDealers()">Save Map</button>
            <span class="status" id="dealers-status"></span>
          </div>
        </details>


        <details class="card full-width">
          <summary>
            <h2>News Management</h2>
          </summary>
          <div class="card-content">
            <form id="news-form" enctype="multipart/form-data">
              <h3>Add / Edit</h3>
              <div class="form-group"><label for="news-title">Title</label><input type="text" id="news-title"
                  name="title" required></div>
              <div class="form-group"><label for="news-date">Date</label><input type="date" id="news-date" name="date"
                  required></div>
              <div class="form-group"><label for="news-summary">Summary</label><textarea id="news-summary"
                  name="summary"></textarea></div>
              <div class="form-group"><label for="news-alt">Alt Text</label><input type="text" id="news-alt" name="alt">
              </div>

              <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="news-save-the-date" name="save_the_date" value="1" style="width: auto;">
                <label for="news-save-the-date" style="margin-bottom: 0;">Show "Save the Date" Stamp</label>
              </div>

              <div class="form-group">
                <label>Main Image</label>
                <input type="file" id="news-image" name="mainImage" accept="image/*">
                <p class="muted" style="margin:5px 0;">OR URL (e.g. from library below):</p>
                <input type="text" id="news-image-url" name="image_url" placeholder="https://...">
              </div>
              <div class="form-group">
                <label for="news-gallery">Gallery (Optional)</label>
                <input type="file" id="news-gallery" name="gallery[]" accept="image/*" multiple>
              </div>

              <input type="hidden" name="action" value="addNews">
              <input type="hidden" name="password">
              <input type="hidden" name="username">
              <input type="hidden" name="lang" value="en">
              <div class="form-actions">
                <button type="submit">Add News</button>
                <button type="button" id="cancel-edit" style="display:none;">Cancel Edit</button>
                <span class="status" id="news-status"></span>
              </div>
            </form>

            <hr style="margin: 2rem 0; border-top:1px solid #eee;">

            <h3>News List</h3>
            <ul class="news-preview" id="news-preview"></ul>
          </div>
        </details>

        <details class="card full-width">
          <summary>
            <h2>Media Library</h2>
          </summary>
          <div class="card-content">
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <h4>Upload new image</h4>
              <form id="media-upload-form" style="display: flex; gap: 10px; align-items: center;">
                <input type="file" name="file" accept="image/*" required>
                <button type="submit">Upload</button>
              </form>
              <div id="media-upload-status" class="status"></div>
            </div>
            <p class="muted">Click image to copy URL.</p>
            <div id="media-list" class="media-grid">
              <p>Loading...</p>
            </div>
          </div>
        </details>
        <details class="card full-width">
          <summary>
            <h2>Newsletter Management</h2>
          </summary>
          <div class="card-content">
            <p style="margin-bottom: 1rem; color: #666;">Manage newsletter subscriptions and campaigns.</p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
              <h3 style="margin-top: 0;">Quick Links</h3>
              <a href="/newsletter" target="_blank" style="display: inline-block; padding: 0.6rem 1.2rem; background: var(--primary); color: white; text-decoration: none; border-radius: 4px; font-weight: 500; margin-right: 10px;">
                Open Newsletter Admin
              </a>
              <a href="/newsletter/subscribers" target="_blank" style="display: inline-block; padding: 0.6rem 1.2rem; background: #666; color: white; text-decoration: none; border-radius: 4px; font-weight: 500;">
                View Subscribers
              </a>
            </div>
            <form id="newsletter-config-form">
              <h3>Newsletter Configuration</h3>
              <div class="form-group">
                <label for="newsletter-url">Newsletter Admin URL</label>
                <input type="text" id="newsletter-url" name="newsletterUrl" placeholder="https://newsletter.example.com">
                <p class="muted" style="margin:5px 0; font-size:0.85rem;">URL to your newsletter management system</p>
              </div>
              <div class="form-group">
                <label for="newsletter-enabled">Enable Newsletter Signup</label>
                <input type="checkbox" id="newsletter-enabled" name="newsletterEnabled" value="1" style="width: auto;">
                <p class="muted" style="margin:5px 0; font-size:0.85rem;">Show newsletter signup form on the website</p>
              </div>
              <input type="hidden" name="action" value="updateNewsletterConfig">
              <input type="hidden" name="password">
              <input type="hidden" name="username">
              <input type="hidden" name="lang" value="en">
              <div class="form-actions">
                <button type="submit">Save Configuration</button>
                <span class="status" id="newsletter-config-status"></span>
              </div>
            </form>
          </div>
        </details>

        <details class="card full-width">
          <summary>
            <h2>Account Settings</h2>
          </summary>
          <div class="card-content">
            <form id="password-form">
              <h3>Change Password</h3>
              <div class="form-group">
                <label>Old Password</label>
                <input type="password" name="old_password" required>
              </div>
              <div class="form-group">
                <label>New Password</label>
                <input type="password" name="new_password" required>
              </div>
              <p class="muted" style="font-size:0.8rem">Applies to currently logged in user.</p>
              <input type="hidden" name="action" value="changePassword">
              <input type="hidden" name="password"> <!-- Will be populated with currentPassword -->
              <div class="form-actions">
                <button type="submit">Update Password</button>
                <span class="status" id="password-status"></span>
              </div>
            </form>
          </div>
        </details>
      </div> <!-- End .cms-grid -->
    </div>
  </div>

  <script>
    // Removed legacy translation object

    let currentPassword = '';
    let currentUsername = '';
    let currentNewsData = [];
    let currentPresidium = [];
    let currentPartners = [];
    let currentDealers = {};
    let currentMissionCards = []; // Dynamic Array
    let currentHeroImages = []; // Dynamic Array for Hero
    let activeMediaInput = null; // Track which input is being filled from gallery
    let editIndex = -1;

    // Removed applyLanguage() as we are now English-only

    function updateNewsFormTitle() {
      const formTitle = document.querySelector('#news-form h3');
      if (formTitle) {
        formTitle.textContent = (editIndex >= 0) ? "Edit News" : "Add News";
      }
    }

    function updateNewsFormButtons() {
      const submitBtn = document.querySelector('#news-form button[type="submit"]');
      const cancelBtn = document.getElementById('cancel-edit-btn');

      if (editIndex >= 0) {
        submitBtn.textContent = "Save Changes";
        if (!cancelBtn) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.id = 'cancel-edit-btn';
          btn.textContent = "Cancel Edit";
          btn.onclick = resetNewsForm;
          btn.style.marginLeft = '10px';
          btn.style.backgroundColor = '#666';
          document.querySelector('#news-form .form-actions').appendChild(btn);
        } else {
          cancelBtn.textContent = "Cancel Edit";
          cancelBtn.style.display = 'inline-block';
        }
      } else {
        submitBtn.textContent = "Add News";
        if (cancelBtn) cancelBtn.style.display = 'none';
      }
    }

    function setStatus(elementId, message, isSuccess = true) {
      const el = document.getElementById(elementId);
      if (!el) return;
      el.textContent = message;
      el.classList.toggle('success', isSuccess);
      el.classList.toggle('error', !isSuccess);

      // clear status after 5 seconds
      setTimeout(() => {
        if (el.textContent === message) el.textContent = '';
      }, 5000);
    }

    async function fetchContent() {
      try {
        const response = await fetch('api/cms-save.php?t=' + Date.now()); // default GET returns JSON
        if (!response.ok) throw new Error('Fetch failed');
        const data = await response.json();

        // 1. Hero
        if (data.hero) {
          document.getElementById('hero-title').value = data.hero.title || '';
          document.getElementById('hero-subtitle').value = data.hero.subtitle || '';
          currentHeroImages = data.hero.images || (data.hero.image ? [data.hero.image] : []);
          renderHeroImagesEditor();
        }

        // 2. Mission
        if (data.mission) {
          document.getElementById('mission-title').value = data.mission.title || '';
          document.getElementById('mission-lead').value = data.mission.lead || '';
          currentMissionCards = data.mission.cards || {};
          renderMissionCardsEditor();
        }

        // 3. Contact
        if (data.contact) {
          document.getElementById('contact-name').value = data.contact.name || '';
          document.getElementById('contact-address').value = data.contact.address || '';
          document.getElementById('contact-phone').value = data.contact.phone || '';
          document.getElementById('contact-email').value = data.contact.email || '';
        }

        // 4. Presidium & Partners
        currentPresidium = data.presidium || [];
        renderPresidiumEditor();

        currentPartners = data.partners || [];
        renderPartnersEditor();

        // 5. Dealers
        currentDealers = data.dealers || {};
        renderDealersEditor();

        // 6. News
        currentNewsData = data.news || [];
        // Sort by date desc
        currentNewsData.sort((a, b) => new Date(b.date) - new Date(a.date));
        renderNewsList();

        fetchMediaLibrary(); // Load media library

      } catch (err) {
        console.error(err);
        setStatus('hero-status', "Unable to load data", false);
      }
    }

    function renderNewsList() {
      const preview = document.getElementById('news-preview');
      preview.innerHTML = '';

      currentNewsData.forEach((item, index) => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.marginBottom = '0.5rem';
        li.style.padding = '0.5rem';
        li.style.borderBottom = '1px solid #eee';

        if (item.visible === false) {
          li.style.opacity = '0.5';
          li.style.background = '#f0f0f0';
        }

        const span = document.createElement('span');
        const date = new Date(item.date).toLocaleDateString();
        span.textContent = `${date} – ${item.title} ${item.visible === false ? '[HIDDEN]' : ''}`;

        const actionsDiv = document.createElement('div');
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '5px';

        const toggleBtn = document.createElement('button');
        toggleBtn.textContent = item.visible === false ? 'Show' : 'Hide';
        toggleBtn.style.fontSize = '0.8rem';
        toggleBtn.onclick = () => toggleVisibility(item.id);

        const editBtn = document.createElement('button');
        editBtn.textContent = "Edit";
        editBtn.style.fontSize = '0.8rem';
        editBtn.onclick = () => loadNewsForEdit(index);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = "Delete";
        deleteBtn.style.fontSize = '0.8rem';
        deleteBtn.style.backgroundColor = '#b00020';
        deleteBtn.style.color = '#fff';
        deleteBtn.style.border = 'none';
        deleteBtn.style.padding = '2px 8px';
        deleteBtn.style.borderRadius = '3px';
        deleteBtn.onclick = () => deleteNewsItem(item.id, index);

        actionsDiv.appendChild(toggleBtn);
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);

        li.appendChild(span);
        li.appendChild(actionsDiv);
        preview.appendChild(li);
      });
    }
    function scrollToGallery(input) {
      activeMediaInput = input;
      const gallery = document.getElementById('media-library').closest('details');
      if (gallery) {
        gallery.open = true;
        document.getElementById('media-library').scrollIntoView({ behavior: 'smooth' });
        setStatus('media-upload-status', "Select an image from the library below.");
      }
    }

    async function toggleVisibility(id) {
      if (!id) return;
      const formData = new FormData();
      formData.append('action', 'toggleNewsVisibility');
      formData.append('id', id);
      formData.append('password', currentPassword);
      formData.append('username', currentUsername);
      formData.append('lang', 'en');

      try {
        const response = await fetch('api/cms-save.php', {
          method: 'POST',
          body: formData
        });
        const text = await response.text();
        if (response.ok) {
          fetchContent();
        } else {
          alert('Error: ' + text);
        }
      } catch (e) {
        console.error(e);
      }
    }

    // --- Dynamic Hero Logic ---
    function renderHeroImagesEditor() {
      const list = document.getElementById('hero-images-list');
      list.innerHTML = '';
      currentHeroImages.forEach((url, idx) => {
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.gap = '10px';
        div.style.marginBottom = '10px';
        div.style.padding = '10px';
        div.style.border = '1px solid #eee';
        div.style.borderRadius = '4px';
        div.style.background = '#f9f9f9';

        // Reordering Arrows
        const reorderDiv = document.createElement('div');
        reorderDiv.style.display = 'flex';
        reorderDiv.style.flexDirection = 'column';
        reorderDiv.style.gap = '2px';

        const upBtn = document.createElement('button');
        upBtn.textContent = '▲';
        upBtn.type = 'button';
        upBtn.style.padding = '2px 5px';
        upBtn.style.fontSize = '10px';
        upBtn.disabled = idx === 0;
        upBtn.onclick = () => {
          [currentHeroImages[idx], currentHeroImages[idx - 1]] = [currentHeroImages[idx - 1], currentHeroImages[idx]];
          renderHeroImagesEditor();
          updateHiddenHeroInput();
        };

        const downBtn = document.createElement('button');
        downBtn.textContent = '▼';
        downBtn.type = 'button';
        downBtn.style.padding = '2px 5px';
        downBtn.style.fontSize = '10px';
        downBtn.disabled = idx === currentHeroImages.length - 1;
        downBtn.onclick = () => {
          [currentHeroImages[idx], currentHeroImages[idx + 1]] = [currentHeroImages[idx + 1], currentHeroImages[idx]];
          renderHeroImagesEditor();
          updateHiddenHeroInput();
        };

        reorderDiv.appendChild(upBtn);
        reorderDiv.appendChild(downBtn);

        // Thumbnail preview
        const thumb = document.createElement('img');
        thumb.src = url || 'images/placeholder.png';
        thumb.style.width = '60px';
        thumb.style.height = '40px';
        thumb.style.objectFit = 'cover';
        thumb.style.borderRadius = '2px';
        thumb.style.border = '1px solid #ddd';
        thumb.onerror = () => { thumb.src = 'images/placeholder.png'; };

        const input = document.createElement('input');
        input.type = 'text';
        input.value = url;
        input.placeholder = "Image URL";
        input.style.flex = '1';
        input.onchange = (e) => {
          currentHeroImages[idx] = e.target.value;
          thumb.src = e.target.value || 'images/placeholder.png';
          updateHiddenHeroInput();
        };

        const galleryBtn = document.createElement('button');
        galleryBtn.textContent = 'Gallery';
        galleryBtn.type = 'button';
        galleryBtn.style.padding = '5px 10px';
        galleryBtn.onclick = () => scrollToGallery(input);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Remove';
        delBtn.className = 'btn-danger';
        delBtn.style.padding = '5px 10px';
        delBtn.type = 'button';
        delBtn.onclick = () => {
          currentHeroImages.splice(idx, 1);
          renderHeroImagesEditor();
          updateHiddenHeroInput();
        };

        div.appendChild(reorderDiv);
        div.appendChild(thumb);
        div.appendChild(input);
        div.appendChild(galleryBtn);
        div.appendChild(delBtn);
        list.appendChild(div);
      });
      updateHiddenHeroInput();
    }

    function addHeroImageRow() {
      currentHeroImages.push('');
      renderHeroImagesEditor();
    }

    function updateHiddenHeroInput() {
      document.getElementById('hero-images-json').value = JSON.stringify(currentHeroImages);
    }

    // --- Dynamic Mission Cards Logic ---
    function renderMissionCardsEditor() {
      const list = document.getElementById('mission-cards-list');
      list.innerHTML = '';

      // Convert Object to Array if needed (legacy support)
      let cards = [];
      if (Array.isArray(currentMissionCards)) {
        cards = currentMissionCards;
      } else {
        cards = Object.values(currentMissionCards);
      }
      currentMissionCards = cards;

      currentMissionCards.forEach((card, idx) => {
        const div = document.createElement('div');
        div.className = 'media-item';
        div.style.alignItems = 'flex-start';
        div.style.marginBottom = '10px';
        div.style.padding = '10px';
        div.style.display = 'block';

        div.innerHTML = `
          <div style="margin-bottom:5px;">
             <label style="font-size:0.8rem;">Title</label>
             <input type="text" value="${(card.title || '').replace(/"/g, '&quot;')}" onchange="updateMissionCard(${idx}, 'title', this.value)">
          </div>
          <div style="margin-bottom:5px;">
             <label style="font-size:0.8rem;">Text</label>
             <textarea onchange="updateMissionCard(${idx}, 'text', this.value)">${(card.text || '')}</textarea>
          </div>
          <button type="button" onclick="removeMissionCard(${idx})" style="font-size:0.8rem; background:#b00020; color:white;">Remove Card</button>
        `;
        list.appendChild(div);
      });

      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.textContent = '+ Add Card';
      addBtn.onclick = addMissionCard;
      list.appendChild(addBtn);
    }

    function addMissionCard() {
      if (!Array.isArray(currentMissionCards)) currentMissionCards = [];
      currentMissionCards.push({
        title: '',
        text: ''
      });
      renderMissionCardsEditor();
    }

    function removeMissionCard(idx) {
      currentMissionCards.splice(idx, 1);
      renderMissionCardsEditor();
    }

    function updateMissionCard(idx, field, value) {
      if (currentMissionCards[idx]) {
        currentMissionCards[idx][field] = value;
      }
    }

    function prepareMissionData() {
      document.getElementById('mission-cards-json').value = JSON.stringify(currentMissionCards);
    }


    // --- Partners Logic ---
    function renderPartnersEditor() {
      const list = document.getElementById('partners-list');
      list.innerHTML = '';
      currentPartners.forEach((p, idx) => {
        const url = typeof p === 'string' ? p : p.url;
        const link = typeof p === 'string' ? '' : (p.link || '');

        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.gap = '10px';
        div.style.marginBottom = '10px';
        div.style.padding = '10px';
        div.style.border = '1px solid #eee';
        div.style.borderRadius = '4px';

        // Thumbnail
        const thumb = document.createElement('img');
        thumb.src = url || 'images/placeholder.png';
        thumb.style.width = '50px';
        thumb.style.height = '30px';
        thumb.style.objectFit = 'contain';
        thumb.style.background = '#fff';
        thumb.style.border = '1px solid #ddd';
        thumb.onerror = () => { thumb.src = 'images/placeholder.png'; };

        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.value = url;
        urlInput.placeholder = 'Logo URL';
        urlInput.style.flex = '1';
        urlInput.onchange = (e) => {
          if (typeof currentPartners[idx] === 'string') currentPartners[idx] = { url: '', link: '' };
          currentPartners[idx].url = e.target.value;
          thumb.src = e.target.value || 'images/placeholder.png';
        };

        const galleryBtn = document.createElement('button');
        galleryBtn.textContent = 'Gallery';
        galleryBtn.type = 'button';
        galleryBtn.style.padding = '5px 10px';
        galleryBtn.onclick = () => scrollToGallery(urlInput);

        const linkInput = document.createElement('input');
        linkInput.type = 'text';
        linkInput.value = link;
        linkInput.placeholder = 'Website URL';
        linkInput.style.flex = '1';
        linkInput.onchange = (e) => {
          if (typeof currentPartners[idx] === 'string') currentPartners[idx] = { url: '', link: '' };
          currentPartners[idx].link = e.target.value;
        };

        const del = document.createElement('button');
        del.textContent = 'Remove';
        del.className = 'btn-danger';
        del.style.padding = '5px 10px';
        del.onclick = () => {
          currentPartners.splice(idx, 1);
          renderPartnersEditor();
        };

        div.appendChild(thumb);
        div.appendChild(urlInput);
        div.appendChild(galleryBtn);
        div.appendChild(linkInput);
        div.appendChild(del);
        list.appendChild(div);
      });
    }

    function addPartnerRow() {
      currentPartners.push({ url: '', link: '' });
      renderPartnersEditor();
    }

    async function savePartners() {
      const formData = new FormData();
      formData.append('action', 'updatePartners');
      formData.append('partners', JSON.stringify(currentPartners));
      formData.append('password', currentPassword);
      formData.append('username', currentUsername);
      formData.append('lang', 'en');

      try {
        const res = await fetch('api/cms-save.php', {
          method: 'POST',
          body: formData
        });
        const text = await res.text();
        setStatus('partners-status', text, res.ok);
      } catch (e) {
        setStatus('partners-status', "Error saving", false);
      }
    }

    // --- Presidium Logic ---
    function renderPresidiumEditor() {
      const list = document.getElementById('presidium-list');
      list.innerHTML = '';
      currentPresidium.forEach((p, idx) => {
        const div = document.createElement('div');
        div.style.border = '1px solid #eee';
        div.style.padding = '10px';
        div.style.marginBottom = '10px';
        div.style.borderRadius = '4px';
        div.style.background = '#fcfcfc';

        // Header with thumbnail
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.gap = '10px';
        header.style.marginBottom = '10px';

        const thumb = document.createElement('img');
        thumb.src = p.image || 'images/placeholder.png';
        thumb.style.width = '40px';
        thumb.style.height = '40px';
        thumb.style.borderRadius = '50%';
        thumb.style.objectFit = 'cover';
        thumb.style.border = '1px solid #ddd';
        thumb.onerror = () => { thumb.src = 'images/placeholder.png'; };

        const nameInput = document.createElement('input');
        nameInput.placeholder = "Name";
        nameInput.value = p.name || '';
        nameInput.style.flex = '1';
        nameInput.onchange = (e) => updatePresidium(idx, 'name', e.target.value);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Remove';
        delBtn.className = 'btn-danger';
        delBtn.style.padding = '5px 10px';
        delBtn.onclick = () => removePresidium(idx);

        header.appendChild(thumb);
        header.appendChild(nameInput);
        header.appendChild(delBtn);

        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = '1fr 1fr';
        grid.style.gap = '10px';

        const roleInput = document.createElement('input');
        roleInput.placeholder = "Role";
        roleInput.value = p.role || '';
        roleInput.onchange = (e) => updatePresidium(idx, 'role', e.target.value);

        const countryInput = document.createElement('input');
        countryInput.placeholder = "Country";
        countryInput.value = p.country || '';
        countryInput.onchange = (e) => updatePresidium(idx, 'country', e.target.value);

        const imgContainer = document.createElement('div');
        imgContainer.style.gridColumn = 'span 2';
        imgContainer.style.display = 'flex';
        imgContainer.style.gap = '5px';

        const imgInput = document.createElement('input');
        imgInput.placeholder = "Image URL";
        imgInput.value = p.image || '';
        imgInput.style.flex = '1';
        imgInput.onchange = (e) => {
          updatePresidium(idx, 'image', e.target.value);
          thumb.src = e.target.value || 'images/placeholder.png';
        };

        const galleryBtn = document.createElement('button');
        galleryBtn.textContent = 'Gallery';
        galleryBtn.type = 'button';
        galleryBtn.onclick = () => scrollToGallery(imgInput);

        imgContainer.appendChild(imgInput);
        imgContainer.appendChild(galleryBtn);

        grid.appendChild(roleInput);
        grid.appendChild(countryInput);
        grid.appendChild(imgContainer);

        div.appendChild(header);
        div.appendChild(grid);
        list.appendChild(div);
      });
    }

    function updatePresidium(idx, field, val) {
      if (!currentPresidium[idx]) currentPresidium[idx] = {};
      currentPresidium[idx][field] = val;
    }

    function addPresidiumRow() {
      currentPresidium.push({
        name: '',
        role: '',
        country: '',
        image: ''
      });
      renderPresidiumEditor();
    }

    function removePresidium(idx) {
      currentPresidium.splice(idx, 1);
      renderPresidiumEditor();
    }

    async function savePresidium() {
      const formData = new FormData();
      formData.append('action', 'updatePresidium');
      formData.append('presidium', JSON.stringify(currentPresidium));
      formData.append('password', currentPassword);
      formData.append('username', currentUsername);
      formData.append('lang', 'en');
      try {
        const res = await fetch('api/cms-save.php', {
          method: 'POST',
          body: formData
        });
        const text = await res.text();
        setStatus('presidium-status', text, res.ok);
      } catch (e) {
        setStatus('presidium-status', "Error saving", false);
      }
    }

    // --- Dealers Logic ---
    function renderDealersEditor() {
      const list = document.getElementById('dealers-list');
      list.innerHTML = '';
      Object.keys(currentDealers).forEach(code => {
        const d = currentDealers[code];
        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '50px 1fr 60px 60px 60px 50px';
        row.style.gap = '5px';
        row.style.marginBottom = '5px';

        row.innerHTML = `
            <input value="${code}" disabled style="background:#f0f0f0;">
            <input value="${(d.country || '').replace(/"/g, '&quot;')}" onchange="updateDealer('${code}', 'country', this.value)">
            <input type="number" value="${d.audi || 0}" onchange="updateDealer('${code}', 'audi', this.value)">
            <input type="number" value="${d.vw || 0}" onchange="updateDealer('${code}', 'vw', this.value)">
            <input type="number" value="${d.vwc || 0}" onchange="updateDealer('${code}', 'vwc', this.value)">
            <button onclick="removeDealer('${code}')" style="color:red;">X</button>
          `;
        list.appendChild(row);
      });
    }

    function updateDealer(code, field, val) {
      if (!currentDealers[code]) return;
      if (field === 'country') currentDealers[code][field] = val;
      else currentDealers[code][field] = parseInt(val) || 0;
    }

    function removeDealer(code) {
      delete currentDealers[code];
      renderDealersEditor();
    }

    function addDealerRow() {
      const code = prompt("Enter Country Code (ISO 2 char), e.g. DE");
      if (!code || code.length !== 2) return;
      if (currentDealers[code.toUpperCase()]) {
        alert("Country already exists!");
        return;
      }
      currentDealers[code.toUpperCase()] = {
        country: '',
        audi: 0,
        vw: 0,
        vwc: 0
      };
      renderDealersEditor();
    }

    async function saveDealers() {
      const formData = new FormData();
      formData.append('action', 'updateDealers');
      formData.append('dealers', JSON.stringify(currentDealers));
      formData.append('password', currentPassword);
      formData.append('username', currentUsername);
      formData.append('lang', 'en');
      try {
        const res = await fetch('api/cms-save.php', {
          method: 'POST',
          body: formData
        });
        const text = await res.text();
        setStatus('dealers-status', text, res.ok);
      } catch (e) {
        setStatus('dealers-status', "Error saving", false);
      }
    }


    // --- News Edit/Delete ---
    function loadNewsForEdit(index) {
      const item = currentNewsData[index];
      if (!item) return;

      editIndex = index;
      document.getElementById('news-title').value = item.title;
      document.getElementById('news-date').value = item.date;
      document.getElementById('news-summary').value = item.summary || '';
      document.getElementById('news-alt').value = item.alt || '';
      document.getElementById('news-image-url').value = item.image || ''; // legacy main image
      document.getElementById('news-save-the-date').checked = !!item.save_the_date;

      const form = document.getElementById('news-form');

      // Update hidden fields if we had them for ID
      let idInput = form.querySelector('input[name="id"]');
      if (!idInput) {
        idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'id';
        form.appendChild(idInput);
      }
      idInput.value = item.id;

      form.querySelector('input[name="action"]').value = 'updateNews';

      updateNewsFormTitle();
      updateNewsFormButtons();

      document.querySelector('details[open] h2:contains("News")')?.scrollIntoView();
      // Or just open the details if closed
      const details = document.getElementById('news-form').closest('details');
      if (details) details.open = true;
    }

    function resetNewsForm() {
      editIndex = -1;
      document.getElementById('news-form').reset();
      document.querySelector('#news-form input[name="action"]').value = 'addNews';
      const idInput = document.querySelector('#news-form input[name="id"]');
      if (idInput) idInput.remove();
      updateNewsFormTitle();
      updateNewsFormButtons();
    }

    async function deleteNewsItem(id, index) {
      if (!confirm("Are you sure you want to delete this news item?")) return;

      const formData = new FormData();
      formData.append('action', 'deleteNews');
      formData.append('id', id);
      formData.append('password', currentPassword);
      formData.append('username', currentUsername);
      formData.append('lang', 'en');

      try {
        const response = await fetch('api/cms-save.php', {
          method: 'POST',
          body: formData
        });
        const text = await response.text();
        if (response.ok) {
          fetchContent();
        } else {
          alert('Error: ' + text);
        }
      } catch (e) {
        alert('Delete failed');
      }
    }


    // Login & Generic Form Handling
    document.getElementById('login-button').addEventListener('click', async () => {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      const btn = document.getElementById('login-button');
      const status = document.getElementById('login-status');

      btn.disabled = true;
      status.textContent = "Logging in...";

      currentUsername = user;
      currentPassword = pass;

      // Update all hidden inputs
      document.querySelectorAll('input[name="username"]').forEach(el => el.value = user);
      document.querySelectorAll('input[name="password"]').forEach(el => el.value = pass);

      document.getElementById('login-panel').style.display = 'none';
      document.getElementById('cms-panel').style.display = 'block';
      fetchContent();
    });

    // Handle Forms Submit
    document.querySelectorAll('form').forEach(form => {
      if (form.id === 'media-upload-form') return; // Handled separately

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const statusId = form.querySelector('.status')?.id;

        // Ensure auth is updated
        formData.set('username', currentUsername);
        formData.set('password', currentPassword);

        try {
          const res = await fetch('api/cms-save.php', {
            method: 'POST',
            body: formData
          });
          const text = await res.text();
          if (res.ok) {
            setStatus(statusId, "Saved!", true);
            if (form.id === 'news-form') {
              resetNewsForm();
            }
            fetchContent();
          } else {
            setStatus(statusId, "Error: " + text, false);
          }
        } catch (err) {
          setStatus(statusId, "Error submitting form", false);
        }
      });
    });


    // Media Library Logic
    async function fetchMediaLibrary() {
      const list = document.getElementById('media-list');
      try {
        const res = await fetch('api/cms-save.php?action=listMedia');
        const json = await res.json();
        if (json.blobs) {
          list.innerHTML = '';
          json.blobs.forEach(file => {
            const item = document.createElement('div');
            item.className = 'media-item';

            const img = document.createElement('img');
            img.src = file.url;
            img.title = file.pathname;
            img.onclick = () => {
              // Copy to active input if any
              if (activeMediaInput) {
                activeMediaInput.value = file.url;
                // Trigger change
                activeMediaInput.dispatchEvent(new Event('change'));
                activeMediaInput.focus();
                setStatus('media-upload-status', "Inserted image URL!");
                // Clear active input to avoid accidental overwrites later
                activeMediaInput = null;
              } else {
                navigator.clipboard.writeText(file.url);
                setStatus('media-upload-status', "Copied URL to clipboard!");
              }
            };

            const name = document.createElement('span');
            // Show filename only
            name.textContent = file.pathname.split('/').pop();
            name.style.fontSize = '10px';
            name.style.overflow = 'hidden';
            name.style.textOverflow = 'ellipsis';
            name.style.whiteSpace = 'nowrap';
            name.style.width = '100%';
            name.style.textAlign = 'center';

            item.appendChild(img);
            item.appendChild(name);
            list.appendChild(item);
          });
        }
      } catch (e) {
        list.textContent = "Error loading media.";
      }
    }

    document.getElementById('media-upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      formData.append('username', currentUsername);
      formData.append('password', currentPassword);
      formData.append('action', 'uploadMedia');
      formData.append('lang', 'en');

      try {
        const res = await fetch('api/cms-save.php', {
          method: 'POST',
          body: formData
        });
        const text = await res.text();
        if (res.ok) {
          setStatus('media-upload-status', "File uploaded!");
          fetchMediaLibrary();
          e.target.reset();
        } else {
          setStatus('media-upload-status', "Upload failed: " + text, false);
        }
      } catch (err) {
        setStatus('media-upload-status', "Upload error", false);
      }
    });
  </script>
</body>

</html>